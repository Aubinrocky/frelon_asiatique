<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte des signalements ‚Äì Frelon asiatique (Insights)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    :root {
      --bg: #0b1020; --panel: #131b33; --muted: #9fb0d0;
      --accent: #6ae28a; --accent-2: #e26a6a; --accent-3:#ffd166;
      --text: #e6ecff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { display:flex; gap:12px; align-items:center; padding:10px 14px; background:var(--panel); border-bottom:1px solid #202a4a; }
    header h1 { font-size:16px; margin:0; font-weight:600; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { padding:4px 8px; border-radius:999px; font-size:12px; background:#0e1630; border:1px solid #243058; }
    .legend { display:flex; gap:12px; align-items:center; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; }
    .dot-frelon { background: var(--accent); }
    .dot-nid { background: var(--accent-2); }
    #map { width:100%; height:calc(100vh - 62px); }
    .btn { background:#1a2240; color:var(--text); border:1px solid #2a3869; border-radius:10px; padding:6px 10px; cursor:pointer; font-size:14px; }
    .btn:hover { background:#212c52; }
    .leaflet-popup-content { color:#0b1020; }
    .toast { position:fixed; top:12px; right:12px; background:#0e1630; border:1px solid #243058; color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:13px; box-shadow:0 6px 24px rgba(0,0,0,0.25); display:none; }
    .toast.show { display:block; }

    /* Panneau priorit√©s */
    #priorityPanel {
      position: fixed; right: 12px; bottom: 12px; width: 320px; max-height: 50vh; overflow:auto;
      background: #0e1630; border:1px solid #243058; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,0.35);
      padding: 10px 12px; font-size: 13px;
    }
    #priorityPanel h3 { margin: 4px 0 8px; font-size: 14px; }
    #priorityList { list-style:none; margin:0; padding:0; }
    #priorityList li { padding:6px 6px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    #priorityList li:hover { background:#192248; }
    #priorityList .score { color: var(--muted); font-size:12px; margin-left:8px; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Carte des signalements ‚Äì Frelon asiatique</h1>
      <div class="controls">
        <span id="countBadge" class="badge">Chargement‚Ä¶</span>
        <div class="legend">
          <label><span class="dot dot-frelon"></span><input type="checkbox" id="toggleFrelon" checked> Frelons</label>
          <label><span class="dot dot-nid"></span><input type="checkbox" id="toggleNid" checked> Nids</label>
          <label><input type="checkbox" id="toggleHeat" checked> Carte de chaleur</label>
          <label><input type="checkbox" id="toggleZones" checked> Zones probables</label>
        </div>
        <button id="locateBtn" class="btn">üìç Autour de moi</button>
        <a class="btn" href="#" id="refreshBtn">üîÑ Actualiser</a>
      </div>
    </header>
    <div id="map"></div>
  </div>

  <div id="priorityPanel" style="display:none;">
    <h3>Priorit√©s d‚Äôintervention</h3>
    <ul id="priorityList"></ul>
  </div>

  <div id="toast" class="toast">Position introuvable.</div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Firebase v9 (modular) CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // üëâ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDBhvHztC4w2MYbQG2rTtdJgMiKMo4vos4",
      authDomain: "frelonsasiatiques-d71cc.firebaseapp.com",
      projectId: "frelonsasiatiques-d71cc",
      storageBucket: "frelonsasiatiques-d71cc.firebasestorage.app",
      messagingSenderId: "895220865652",
      appId: "1:895220865652:web:f9c3656604e4b8bb048f21",
      measurementId: "G-P6X6Z218K8"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ------- Map -------
    const map = L.map('map', {
      zoomControl: true, attributionControl: true, preferCanvas: true
    }).setView([46.7, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const state = {
      markers: [],
      raw: [],        // donn√©es filtr√©es (30j)
      rawAll: [],     // toutes les donn√©es
      filters: { frelon: true, nid: true, heat: true, zones: true },
      layers: { heat: null, zones: L.layerGroup().addTo(map), zoneMarkers: L.layerGroup().addTo(map) },
      clusters: []
    };

    // --- Scoring / clustering & r√©cence ---
    const CONFIG = {
      CLUSTER_RADIUS_M: 500,
      MIN_PTS: 3,
      HALF_LIFE_DAYS: 21,     // baisse si tu veux une carte plus "nerveuse" (ex. 14 ou 10)
      RECENT_DAYS: 30,        // ‚¨ÖÔ∏è filtre automatique "30 derniers jours"
      W_TYPE: { frelon: 1, nid: 5 },
      W_QTY_FACTOR: 1/3,
      MIN_ZONE_RADIUS_M: 120,
      MAX_ZONE_RADIUS_M: 600,
      TOP_ZONES: 10
    };

    const colors = { frelon: '#6ae28a', nid: '#e26a6a' };

    // ---------- Utils ----------
    function toJsDate(val) {
      if (!val) return null;
      if (val && typeof val.toDate === 'function') return val.toDate();
      if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
      if (typeof val === 'number') {
        const d = new Date(val < 1e12 ? val * 1000 : val);
        return isNaN(d.getTime()) ? null : d;
      }
      if (typeof val === 'string') {
        const s = val.trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const d = new Date(s + 'T00:00:00Z'); return isNaN(d.getTime()) ? null : d; }
        const d = new Date(s); return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }
    function formatDate(val) {
      const d = toJsDate(val); if (!d) return '‚Äî';
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear(); return `${dd}-${mm}-${yyyy}`;
    }
    const R_EARTH = 6371000;
    function distMeters(aLat, aLng, bLat, bLng) {
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(bLat - aLat), dLng = toRad(bLng - aLng);
      const sLat1 = toRad(aLat), sLat2 = toRad(bLat);
      const h = Math.sin(dLat/2)**2 + Math.cos(sLat1)*Math.cos(sLat2)*Math.sin(dLng/2)**2;
      return 2 * R_EARTH * Math.asin(Math.min(1, Math.sqrt(h)));
    }
    function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }

    // ---------- Markers ----------
    function makeMarker(d) {
      const color = d.type === 'nid' ? colors.nid : colors.frelon;
      const marker = L.circleMarker([d.lat, d.lng], {
        radius: Math.min(14, 6 + (Number(d.quantity)||0)),
        color, fillColor: color, fillOpacity: 0.6, weight: 2
      });
      const title = d.type === 'nid' ? 'Nid signal√©' : 'Frelons observ√©s';
      const quantity = (d.quantity ?? '‚Äî');
      let seen = '‚Äî'; try { seen = formatDate(d.date); } catch(_) {}
      marker.bindPopup(`<strong>${title}</strong><br>Quantit√© : ${quantity}<br>Vu le : ${seen}`);
      marker.__type = d.type;
      return marker;
    }

    function applyFilters() {
      state.markers.forEach(m => {
        const visible = (m.__type === 'nid' && state.filters.nid) || (m.__type === 'frelon' && state.filters.frelon);
        if (visible) m.addTo(map); else map.removeLayer(m);
      });
      if (state.layers.heat) {
        if (state.filters.heat) state.layers.heat.addTo(map); else map.removeLayer(state.layers.heat);
      }
      if (state.filters.zones) { state.layers.zones.addTo(map); state.layers.zoneMarkers.addTo(map); }
      else { map.removeLayer(state.layers.zones); map.removeLayer(state.layers.zoneMarkers); }
    }

    function fitToData() {
      const visible = state.markers.filter(m => map.hasLayer(m));
      if (!visible.length) return;
      const group = L.featureGroup(visible);
      map.fitBounds(group.getBounds().pad(0.2));
    }

    // ---------- R√©cence ----------
    function filterRecent(arr, now = new Date()) {
      const cutoff = now.getTime() - CONFIG.RECENT_DAYS * 24 * 3600 * 1000;
      return arr.filter(d => {
        const dt = toJsDate(d.date);
        return dt && dt.getTime() >= cutoff;
      });
    }

    // ---------- Weights / Heatmap ----------
    function computeWeight(item, now = new Date()) {
      const base = CONFIG.W_TYPE[item.type] || 1;
      const qty = Number(item.quantity) || 0;
      const dt = toJsDate(item.date) || now;
      const ageDays = (now - dt) / (1000*3600*24);
      const decay = Math.pow(0.5, ageDays / CONFIG.HALF_LIFE_DAYS);
      return base * (1 + CONFIG.W_QTY_FACTOR * qty) * decay;
    }

    function updateHeat() {
      if (state.layers.heat) { map.removeLayer(state.layers.heat); state.layers.heat = null; }
      const heatPoints = state.raw
        .filter(d => (d.type==='nid' && state.filters.nid) || (d.type==='frelon' && state.filters.frelon))
        .map(d => [d.lat, d.lng, clamp(computeWeight(d)/5, 0.05, 1.0)]);
      if (!heatPoints.length) return;
      state.layers.heat = L.heatLayer(heatPoints, { radius: 28, blur: 22, maxZoom: 17 });
      if (state.filters.heat) state.layers.heat.addTo(map);
    }

    // ---------- Clustering simple ----------
    function clusterize(points) {
      const n = points.length;
      const adj = Array.from({length:n}, () => []);
      const R = CONFIG.CLUSTER_RADIUS_M;
      for (let i=0;i<n;i++) {
        for (let j=i+1;j<n;j++) {
          const d = distMeters(points[i].lat, points[i].lng, points[j].lat, points[j].lng);
          if (d <= R) { adj[i].push(j); adj[j].push(i); }
        }
      }
      const seen = new Array(n).fill(false), clusters = [];
      for (let i=0;i<n;i++) if (!seen[i]) {
        const stack = [i], comp = [];
        seen[i] = true;
        while(stack.length) {
          const v = stack.pop(); comp.push(v);
          for (const w of adj[v]) if (!seen[w]) { seen[w]=true; stack.push(w); }
        }
        if (comp.length >= CONFIG.MIN_PTS) clusters.push(comp);
      }
      return clusters;
    }

    function computeZones() {
      const pts = state.raw.map(d => ({
        lat: d.lat, lng: d.lng, w: computeWeight(d), type: d.type, date: d.date, quantity: d.quantity
      }));
      if (pts.length === 0) return [];
      const idx = pts.map((_,i)=>i);
      const clustersIdx = clusterize(idx.map(i => pts[i]).map(p => ({lat:p.lat,lng:p.lng})));
      const zones = clustersIdx.map(indices => {
        let sumW=0, cx=0, cy=0;
        const members = indices.map(i => pts[i]);
        for (const p of members) { sumW += p.w; cx += p.lng*p.w; cy += p.lat*p.w; }
        cx /= sumW; cy /= sumW;
        let meanD=0; for (const p of members) meanD += distMeters(cy, cx, p.lat, p.lng);
        meanD /= members.length;
        const radius = clamp(meanD*1.2, CONFIG.MIN_ZONE_RADIUS_M, CONFIG.MAX_ZONE_RADIUS_M);
        const score = sumW / (1 + meanD/100);
        return { center:[cy,cx], radius, score, count:members.length, members };
      });
      zones.sort((a,b)=>b.score-a.score);
      return zones.slice(0, CONFIG.TOP_ZONES);
    }

    function renderZones(zones) {
      state.layers.zones.clearLayers();
      state.layers.zoneMarkers.clearLayers();
      if (!zones.length) { document.getElementById('priorityPanel').style.display='none'; return; }

      zones.forEach((z, i) => {
        const circle = L.circle(z.center, {
          radius: z.radius,
          color: '#ffd166', weight: 2, fillColor: '#ffd166', fillOpacity: 0.18
        }).addTo(state.layers.zones);

        const m = L.marker(z.center, { title: `Zone probable #${i+1}` }).addTo(state.layers.zoneMarkers);
        m.bindPopup(
          `<strong>Zone probable #${i+1}</strong><br>` +
          `Score: ${z.score.toFixed(1)}<br>` +
          `Signalements dans la zone: ${z.count}<br>` +
          `Rayon estim√©: ${Math.round(z.radius)} m`
        );
        m.__focus = () => { map.fitBounds(circle.getBounds().pad(0.4)); m.openPopup(); };
      });

      const panel = document.getElementById('priorityPanel');
      const list = document.getElementById('priorityList');
      panel.style.display = 'block';
      list.innerHTML = '';
      zones.forEach((z, i) => {
        const li = document.createElement('li');
        li.innerHTML = `Zone #${i+1} <span class="score">score ${z.score.toFixed(1)} ¬∑ ~${Math.round(z.radius)} m</span>`;
        li.addEventListener('click', () => {
          const ms = state.layers.zoneMarkers.getLayers();
          const mk = ms[i]; if (mk && mk.__focus) mk.__focus();
        });
        list.appendChild(li);
      });
    }

    function updateInsights() {
      updateHeat();
      const zones = computeZones();
      renderZones(zones);
    }

    // ---------- Data ----------
    async function loadData() {
      const badge = document.getElementById('countBadge');
      badge.textContent = 'Chargement‚Ä¶';

      const q = query(collection(db, 'declaration'), orderBy('date', 'desc'));
      const snap = await getDocs(q);

      // reset
      state.rawAll = [];
      state.raw = [];
      state.markers.forEach(m => map.removeLayer(m));
      state.markers = [];

      snap.forEach(doc => {
        const d = doc.data();
        if (typeof d.lat !== 'number' || typeof d.lng !== 'number') return;
        const type = (d.type === 'nid') ? 'nid' : 'frelon';
        const item = {
          type,
          lat: d.lat,
          lng: d.lng,
          quantity: typeof d.quantity === 'number' ? d.quantity : Number(d.quantity) || 0,
          date: d.date ?? null,
          description: d.description ?? ''
        };
        state.rawAll.push(item);
      });

      // ‚¨áÔ∏è applique le filtre automatique "30 jours"
      state.raw = filterRecent(state.rawAll);

      // cr√©er les marqueurs uniquement pour les r√©cents
      state.raw.forEach(item => {
        const marker = makeMarker(item);
        state.markers.push(marker);
      });

      applyFilters();
      fitToData();
      updateInsights();
      badge.textContent = `${state.raw.length}/${state.rawAll.length} signalement(s) ¬∑ 30j`;
    }

    // ---------- UI ----------
    document.getElementById('toggleFrelon').addEventListener('change', (e) => { state.filters.frelon = e.target.checked; applyFilters(); updateInsights(); });
    document.getElementById('toggleNid').addEventListener('change', (e) => { state.filters.nid = e.target.checked; applyFilters(); updateInsights(); });
    document.getElementById('toggleHeat').addEventListener('change', (e) => { state.filters.heat = e.target.checked; applyFilters(); });
    document.getElementById('toggleZones').addEventListener('change', (e) => { state.filters.zones = e.target.checked; applyFilters(); });

    document.getElementById('refreshBtn').addEventListener('click', (e) => { e.preventDefault(); loadData(); });
    document.getElementById('locateBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return showToast('G√©olocalisation non support√©e.');
      navigator.geolocation.getCurrentPosition(
        pos => { const { latitude, longitude } = pos.coords; map.setView([latitude, longitude], 13); },
        () => showToast('Position introuvable.')
      );
    });

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }

    // start
    loadData().catch(err => {
      console.error(err);
      showToast('Erreur de chargement des donn√©es');
      document.getElementById('countBadge').textContent = 'Erreur';
    });
  </script>
</body>
</html>
