<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte des signalements ‚Äì Frelon asiatique (MVP)</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #0b1020;
      --panel: #131b33;
      --muted: #9fb0d0;
      --accent: #6ae28a;
      --accent-2: #e26a6a;
      --text: #e6ecff;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }

    header {
      display: flex; gap: 12px; align-items: center; padding: 10px 14px; background: var(--panel); border-bottom: 1px solid #202a4a;
    }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; }
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; background: #0e1630; border: 1px solid #243058; }
    .legend { display: flex; gap: 12px; align-items: center; }
    .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; margin-right: 6px; }
    .dot-frelon { background: var(--accent); }
    .dot-nid { background: var(--accent-2); }

    #map { width: 100%; height: calc(100vh - 62px); }

    .btn { background: #1a2240; color: var(--text); border: 1px solid #2a3869; border-radius: 10px; padding: 6px 10px; cursor: pointer; font-size: 14px; }
    .btn:hover { background: #212c52; }

    .leaflet-popup-content { color: #0b1020; }

    .toast { position: fixed; top: 12px; right: 12px; background: #0e1630; border: 1px solid #243058; color: var(--text); padding: 10px 12px; border-radius: 12px; font-size: 13px; box-shadow: 0 6px 24px rgba(0,0,0,0.25); display: none; }
    .toast.show { display: block; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Carte des signalements ‚Äì Frelon asiatique</h1>
      <div class="controls">
        <span id="countBadge" class="badge">Chargement‚Ä¶</span>
        <div class="legend">
          <label><span class="dot dot-frelon"></span><input type="checkbox" id="toggleFrelon" checked> Frelons</label>
          <label><span class="dot dot-nid"></span><input type="checkbox" id="toggleNid" checked> Nids</label>
        </div>
        <button id="locateBtn" class="btn">üìç Autour de moi</button>
        <a class="btn" href="#" id="refreshBtn">üîÑ Actualiser</a>
      </div>
    </header>
    <div id="map"></div>
  </div>

  <div id="toast" class="toast">Position introuvable.</div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Firebase v9 (modular) CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // üëâ config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDBhvHztC4w2MYbQG2rTtdJgMiKMo4vos4",
      authDomain: "frelonsasiatiques-d71cc.firebaseapp.com",
      projectId: "frelonsasiatiques-d71cc",
      storageBucket: "frelonsasiatiques-d71cc.firebasestorage.app",
      messagingSenderId: "895220865652",
      appId: "1:895220865652:web:f9c3656604e4b8bb048f21",
      measurementId: "G-P6X6Z218K8"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ------- Leaflet map -------
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([46.7, 2.5], 6); // Vue g√©n√©rale France

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const state = {
      markers: [],
      raw: [],
      filters: { frelon: true, nid: true }
    };

    const colors = {
      frelon: '#6ae28a', // vert
      nid: '#e26a6a'     // rouge
    };

    // Remplace TOTALEMENT ta fonction formatDate par ces 2 fonctions :
function toJsDate(val) {
  if (!val) return null;

  // Firestore Timestamp ?
  if (val && typeof val.toDate === 'function') {
    return val.toDate();
  }
  // Date JS ?
  if (val instanceof Date) {
    return isNaN(val.getTime()) ? null : val;
  }
  // Nombre (ms ou secondes)
  if (typeof val === 'number') {
    const d = new Date(val < 1e12 ? val * 1000 : val);
    return isNaN(d.getTime()) ? null : d;
  }
  // Cha√Æne (ISO ou YYYY-MM-DD)
  if (typeof val === 'string') {
    const s = val.trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      const d = new Date(s + 'T00:00:00Z');
      return isNaN(d.getTime()) ? null : d;
    }
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }
  return null;
}

function formatDate(val) {
  const d = toJsDate(val);
  if (!d) return '‚Äî';
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

// Dans makeMarker, s√©curise l‚Äôappel (optionnel mais conseill√©) :
function makeMarker(d) {
  const color = d.type === 'nid' ? '#e26a6a' : '#6ae28a';
  const marker = L.circleMarker([d.lat, d.lng], {
    radius: Math.min(14, 6 + (Number(d.quantity)||0)),
    color, fillColor: color, fillOpacity: 0.6, weight: 2
  });
  const title = d.type === 'nid' ? 'Nid signal√©' : 'Frelons observ√©s';
  const quantity = (d.quantity ?? '‚Äî');

  let seen = '‚Äî';
  try { seen = formatDate(d.date); } catch(_) {}

  marker.bindPopup(`
    <strong>${title}</strong><br>
    Quantit√© : ${quantity}<br>
    Vu le : ${seen}
  `);
  marker.__type = d.type;
  return marker;

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function applyFilters() {
      state.markers.forEach(m => {
        const visible = (m.__type === 'nid' && state.filters.nid) || (m.__type === 'frelon' && state.filters.frelon);
        if (visible) {
          m.addTo(map);
        } else {
          map.removeLayer(m);
        }
      });
    }

    function fitToData() {
      const visible = state.markers.filter(m => map.hasLayer(m));
      if (!visible.length) return;
      const group = L.featureGroup(visible);
      map.fitBounds(group.getBounds().pad(0.2));
    }

    async function loadData() {
      const badge = document.getElementById('countBadge');
      badge.textContent = 'Chargement‚Ä¶';
      // Trie par date descendante pour avoir les plus r√©cents d'abord
      const q = query(collection(db, 'declaration'), orderBy('date', 'desc'));
      const snap = await getDocs(q);
      state.raw = [];

      // Nettoyage anciens marqueurs
      state.markers.forEach(m => map.removeLayer(m));
      state.markers = [];

      snap.forEach(doc => {
        const d = doc.data();
        if (typeof d.lat !== 'number' || typeof d.lng !== 'number') return; // on ignore
        const type = (d.type === 'nid') ? 'nid' : 'frelon';
        const item = {
          type,
          lat: d.lat,
          lng: d.lng,
          quantity: typeof d.quantity === 'number' ? d.quantity : Number(d.quantity) || 0,
          date: d.date ?? null,     // laiss√© tel quel, g√©r√© par formatDate()
          description: d.description ?? ''
        };
        state.raw.push(item);
        const marker = makeMarker(item);
        state.markers.push(marker);
      });

      applyFilters();
      fitToData();
      badge.textContent = `${state.raw.length} signalement(s)`;
    }

    // UI handlers
    document.getElementById('toggleFrelon').addEventListener('change', (e) => {
      state.filters.frelon = e.target.checked;
      applyFilters();
    });
    document.getElementById('toggleNid').addEventListener('change', (e) => {
      state.filters.nid = e.target.checked;
      applyFilters();
    });

    document.getElementById('refreshBtn').addEventListener('click', (e) => {
      e.preventDefault();
      loadData();
    });

    document.getElementById('locateBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return showToast('G√©olocalisation non support√©e.');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 13);
        },
        () => showToast('Position introuvable.')
      );
    });

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2500);
    }

    // Charge au d√©marrage
    loadData().catch(err => {
      console.error(err);
      showToast('Erreur de chargement des donn√©es');
      document.getElementById('countBadge').textContent = 'Erreur';
    });
  </script>
</body>
</html>
